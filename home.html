<script>
navigator.serviceWorker.register('/iframe_test_website/sw.js')
  // Step 1: Wait for the registration's active worker to exist
  .then(reg => {
    if (reg.active) return reg;
    return new Promise(resolve => {
      const check = () => {
        if (reg.active) resolve(reg);
        else setTimeout(check, 10);
      };
      check();
    });
  })

  // Step 2: Wait for THAT active worker to become the controller
  .then(reg => {
    if (navigator.serviceWorker.controller === reg.active) {
      return reg;
    }
    return new Promise(resolve => {
      function onChange() {
        if (navigator.serviceWorker.controller === reg.active) {
          navigator.serviceWorker.removeEventListener('controllerchange', onChange);
          resolve(reg);
        }
      }
      navigator.serviceWorker.addEventListener('controllerchange', onChange);
    });
  })

  // Step 3: Now the new SW controls the page - run detection logic
  .then(reg => {
    navigator.serviceWorker.onmessage = (e) => {
      reg.unregister().then(() => {
        window.parent.postMessage({ type: 'isChatGPTAtlas', result: e.data }, '*');
      });
    };
    fetch('https://chatgpt.com/test', { mode: 'no-cors', referrerPolicy: 'no-referrer' });
  });
</script>
